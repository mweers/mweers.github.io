<!DOCTYPE html>
<html>
<head>
    <title>Daily Step Count Activity Graph</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 90%;
            height: 100%;
        }
        .tooltip {
            position: absolute;
            text-align: left;
            width: auto;
            height: auto;
            padding: 2px;
            font: 12px sans-serif;
            background: oklch(1 0 89.876);
            border: 1px solid oklch(0.898 0 89.876);
            border-radius: 3px;
            pointer-events: none;
            opacity: 0;
            z-index: 10;
        }
    </style>
</head>
<body>
<div class="tooltip" id="tooltip"></div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const parseDate = d3.timeParse("%m/%d/%Y");
        const formatDate = d3.timeFormat("%_m/%e/%Y");
        const tooltip = d3.select("#tooltip");
        let svg;

        const debounce = (func, wait) => {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        };

        const calculateSquareSize = () => {
            const gutter = 20;
            const windowWidth = window.innerWidth - gutter;
            const squarePad = 1;
            const squareSize = 15;
            const squaresInRow = Math.floor(windowWidth / (squareSize + squarePad));
            return [(windowWidth / squaresInRow) - squarePad, squarePad, squaresInRow];
        };

        function determineColor(steps) {
            if (steps <= 15000) return 'oklch(90% 0.14 145deg)'; // Light muted green
            else if (steps <= 25000) return 'oklch(80% 0.17 145deg)'; // Light green
            else if (steps <= 50000) return 'oklch(70% 0.20 145deg)'; // Mid green
            else if (steps <= 70000) return 'oklch(60% 0.23 145deg)'; // Dark green
            else return 'oklch(50% 0.26 145deg)'; // Darker muted green
        }

        const drawGraph = () => {
            const [squareSize, squarePad, squaresInRow] = calculateSquareSize();

            d3.csv('https://raw.githubusercontent.com/mweers/mweers.github.io/master/steps.csv')
                .then(data => {
                    data.forEach(d => {
                        d.Date = parseDate(d.Date);
                        d.Steps = +d.Steps;
                    });

                    const svgHeight = (squareSize + squarePad) * Math.ceil(data.length / squaresInRow);
                    svg = d3.select('body').selectAll('svg').data([null]);
                    svg = svg.enter().append('svg').merge(svg)
                        .attr('width', window.innerWidth)
                        .attr('height', svgHeight);

                    const squares = svg.selectAll('.day-square').data(data);
                    squares.enter().append('rect')
                        .merge(squares)
                        .attr('class', 'day-square')
                        .attr('x', (_, i) => (squareSize + squarePad) * (i % squaresInRow))
                        .attr('y', (_, i) => (squareSize + squarePad) * Math.floor(i / squaresInRow))
                        .attr('width', squareSize)
                        .attr('height', squareSize)
                        .attr('fill', d => determineColor(d.Steps))
                        .on('mouseover', function(event, d) {
                            // Get tooltip dimensions
                            const tooltipWidth = tooltip.node().getBoundingClientRect().width;
                            const tooltipHeight = tooltip.node().getBoundingClientRect().height;

                            // Calculate position for tooltip
                            let topPosition = event.pageY - tooltipHeight - 10;
                            let leftPosition = event.pageX + 5;

                            // Ensure the tooltip is always within the visible window
                            if (leftPosition + tooltipWidth > window.innerWidth) {
                                leftPosition = window.innerWidth - tooltipWidth - 5;
                            }
                            if (topPosition < 0) {
                                topPosition = event.pageY + 10; // Place it below the mouse cursor if it goes above the window
                            }

                            // Display the tooltip with updated position
                            tooltip.transition()
                                .duration(200)
                                .style('opacity', .9);
                            tooltip.html('Date: ' + formatDate(d.Date) + '<br>Steps: ' + d.Steps)
                                .style('left', leftPosition + 'px')
                                .style('top', topPosition + 'px');
                        })
                        .on('mouseout', function(d) {
                            tooltip.transition()
                                .duration(500)
                                .style('opacity', 0);
                        });

                }).catch(error => {
                console.error('Error loading the data: ', error);
            });
        };

        window.addEventListener('resize', debounce(drawGraph, 250));
        window.addEventListener('load', drawGraph);
    });
</script>
</body>
</html>
